# CamView

単一のHTMLファイルで動作する、Webカメラ表示・録画・リモート制御アプリケーション

## 概要

CamViewは、ブラウザ上で動作するカメラビューアーアプリケーションです。複数のカメラを切り替えて表示し、各カメラごとに詳細な設定を保存できます。また、録画機能やMQTTによるリモート制御にも対応しています。

## 主な機能

### カメラ表示
- 複数カメラの選択と切り替え
- カメラごとの個別設定
- フルスクリーン表示

### 録画機能
- 最大60秒の録画
- 最大3本の録画を保存（IndexedDB使用）
- 録画のループ再生

### カメラ設定（カメラごとに保存）
- **変形・回転**
  - 水平反転・垂直反転
  - 0/90/180/270度回転

- **フィルター**
  - 明度（brightness）
  - コントラスト（contrast）
  - 色相（hue-rotate）
  - 彩度（saturate）
  - ぼかし（blur）
  - セピア（sepia）
  - グレースケール（grayscale）
  - 不透明度（opacity）
  - 反転（invert）

- **表示領域**
  - クロップ範囲指定（FullHD基準のピクセル座標）
  - 背景色設定

### MQTT機能
- ブローカーへの自動接続
- カメラ切り替え制御
- 録画再生制御
- Will メッセージ（online/away）

## キーボード操作

| キー | 機能 |
|------|------|
| `←` / `→` | カメラ切り替え |
| `S` | 設定画面開閉 |
| `ESC` | 設定画面を閉じる / 再生を停止 |
| `F` | フルスクリーン切り替え |
| `R` | 録画開始/停止 |

## 使い方

### 初回起動
1. ブラウザで `index.html` を開く
2. カメラアクセスの許可を求められたら「許可」をクリック
3. 使用するカメラを選択して「決定」をクリック

### カメラ設定
1. 画面右上にマウスを移動すると歯車アイコンが表示されます
2. 歯車アイコンをクリック、または `S` キーで設定画面を開く
3. 右側のサイドバーで各種設定を調整
4. 設定は自動的に保存されます

### 録画
1. `R` キーを押すと録画開始
2. 再度 `R` キーを押すか、60秒経過で録画停止
3. 設定画面の「録画管理」から再生・削除が可能

### MQTT設定
1. 設定画面を開く
2. 「MQTT接続設定」ボタンをクリック
3. 以下の情報を入力：
   - プロトコル（ws/wss）
   - ホスト名
   - ポート番号
   - トピックプレフィックス
   - Will メッセージ設定
   - 認証情報（オプション）
4. 「OK」をクリックすると自動的に接続されます

#### MQTTトピック構造

プレフィックスを `camview/device1` と設定した場合：

**Subscribe（受信）:**
- `camview/device1/camera` - カメラ切り替え（ペイロード: カメラインデックス 0, 1, 2...）
- `camview/device1/video` - 録画再生（ペイロード: 録画インデックス 0, 1, 2）

**Publish（送信）:**
- `camview/device1/status` - ステータス（接続時: `online`, 切断時: `away`）※Retain設定

### エクスポート/インポート
1. 設定画面を開く
2. 「エクスポート」ボタンをクリックすると、設定がJSON形式でダウンロードされ、テキストエリアにも表示されます
3. インポートする場合は、テキストエリアにJSONを貼り付けて「インポート」ボタンをクリック

## データ保存

### LocalStorage
- カメラ設定（全カメラ分）
- 選択中のカメラ
- MQTT接続設定

### IndexedDB
- 録画動画データ（最大3本）

## 技術仕様

- **単一ファイル**: HTML/CSS/JavaScriptが1ファイルに統合
- **外部ライブラリ**: MQTT.js (CDN経由)
- **対象ブラウザ**: モダンブラウザ（Chrome/Firefox/Edge最新版）
- **想定解像度**: FullHD (1920x1080)

## IndexedDBの制限事項

- ブラウザによって容量制限あり（通常は利用可能なディスク容量の60-80%）
- ユーザーがブラウザのデータをクリアすると削除される
- 同じオリジン（ドメイン）内でのみアクセス可能

## トラブルシューティング

### カメラが表示されない
- ブラウザのカメラアクセス許可を確認してください
- 他のアプリケーションがカメラを使用していないか確認してください

### MQTT接続エラー（赤ボーダー表示）
- ブローカーのホスト名とポート番号を確認してください
- WebSocket対応のポート（通常9001）を使用してください
- ネットワーク接続を確認してください

### 録画ができない
- ブラウザがMediaRecorder APIに対応しているか確認してください
- すでに3本の録画がある場合は、削除が必要です

## ライセンス

このプロジェクトはオープンソースです。

## 開発履歴

### v1.1.0 (2025-10-20)
- 設定画面のUI/UX改善
  - 設定画面を開いたときにカメラ映像が左上60%に表示されるように修正
  - リアルタイムプレビュー機能（設定変更が即座に反映）
  - カメラ切り替え時に各カメラの設定が正しく読み込まれるように改善
- 表示領域機能の改善
  - クロップ処理を廃止し、背景色のオーバーレイ方式に変更
  - object-fit: coverで16:9アスペクト比を保持
  - 画面リサイズへの対応
- キーボードショートカット追加
  - 1/2/3キー: 録画1/2/3を再生
- MQTT機能の改善
  - retain設定の追加（online/awayメッセージ）
- バグ修正
  - 設定画面の開閉時のカメラ映像サイズ問題を修正
  - z-index調整による操作性の改善

### v1.0.0 (2025-10-20)
- 初回リリース
- 基本的なカメラ表示機能
- 録画機能
- MQTT制御機能
- 設定のエクスポート/インポート機能
