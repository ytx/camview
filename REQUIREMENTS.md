# CamView - 完全要件定義書

このドキュメントは、CamViewアプリケーションの開発時に確定した要件をまとめたものです。

## 1. 概要
単一HTMLファイルで動作する、Webカメラ表示・録画・リモート制御アプリケーション

## 2. 基本機能

### 2.1 カメラアクセス
- `navigator.mediaDevices.enumerateDevices()`実行のための権限取得
- 利用可能なカメラを一覧表示
- 複数カメラの選択可能（チェックボックス形式）
- 初回起動時、カメラ未選択の場合は自動的に選択画面を表示

### 2.2 カメラ表示
- 複数カメラ選択時は1台のみ表示
- `←`/`→`キーでカメラ切り替え
- 前回選択していたカメラを起動時に復元
- 想定画面サイズ: FullHD (1920x1080)

### 2.3 UI要素配置
**通常表示時:**
- 画面右上: マウスオーバーで歯車アイコンを表示
- MQTT接続エラー時: カメラ映像外周に赤いボーダー表示
- エラー時: 映像領域中央にエラーメッセージ表示

**録画中:**
- 画面右上: 赤丸インジケータ + 録画時間表示
- インジケータは録画内容に含めない

## 3. キーボード操作

| キー | 機能 |
|------|------|
| `←` / `→` | カメラ切り替え |
| `S` | 設定画面開閉 |
| `ESC` | 設定画面を閉じる |
| `F` | フルスクリーン切り替え |
| `R` | 録画開始/停止 |

## 4. 設定画面

### 4.1 レイアウト構成
```
┌─────────────────────────────────────────────────┐
│ カメラ映像(60%縮小)              │ 設定項目   │
│                                  │ [閉じる]    │
│                                  │             │
│                                  │ ・flip      │
├──────────────────────────────────┤ ・rotate    │
│ カメラ追加/削除                  │ ・filter    │
│ □ Camera 1  □ Camera 2          │ ・size      │
├──────────────────────────────────┤ ・MQTT設定  │
│ 録画映像管理                     │ ・エクスポート│
│ [録画1] [再生] [削除]            │ ・インポート│
│ [録画2] [再生] [削除]            │             │
└─────────────────────────────────────────────────┘
```

### 4.2 設定項目（カメラ毎に保存）

**変形・回転:**
- flip: 水平/垂直（2種類）
- rotate: 0/90/180/270度

**フィルタ（数値調整）:**
- brightness（明度）: 0-200%
- contrast（コントラスト）: 0-200%
- hue-rotate（色相）: 0-360度
- saturate（彩度）: 0-200%
- blur（ぼかし）: 0-20px
- sepia（セピア）: 0-100%
- grayscale（グレースケール）: 0-100%
- opacity（不透明度）: 0-100%
- invert（反転）: 0-100%

**表示領域:**
- size: (x1, y1, x2, y2) - FullHD基準のピクセル座標
  - 指定領域のみ表示、それ以外はbackground色
- background: カラーピッカーで色選択

### 4.3 カメラ追加/削除
- 利用可能なカメラ一覧をチェックボックスで表示
- チェックON/OFFで追加/削除

### 4.4 録画映像管理
- 最大3本の録画を保存（IndexedDB使用）
- 各録画に対して「再生」「削除」ボタン
- 再生時はライブ映像の代わりに録画映像を表示

### 4.5 MQTT設定（モーダル表示）
- ブローカー接続先（ホスト、ポート）
- プロトコル選択（ws/wss）
- 認証情報（ユーザー名、パスワード）
- トピックプレフィックス（例: `camview/device1`）
- Will メッセージ設定（トピック、ペイロード）
- 設定保存時に自動接続
- リロード時、設定があれば自動再接続

### 4.6 エクスポート/インポート
- LocalStorage内の全設定をJSON形式で表示
- テキストエリアで編集可能
- インポート機能
- ファイル名で識別（例: `camview-settings-YYYYMMDD.json`）

## 5. 録画機能

### 5.1 録画制御
- `R`キーで開始/停止
- 最大60秒で自動停止
- 録画中: 画面右上に赤丸 + 経過時間表示（M:SS形式）

### 5.2 録画保存
- 保存先: IndexedDB
- 最大保存数: 3本
- 3本保存済みで新規録画時: 削除する録画を選択させる

### 5.3 録画再生
- 設定画面から再生
- ループ再生
- 再生中はライブ映像を非表示
- ESCキーでライブ映像に戻る

## 6. MQTT機能

### 6.1 接続管理
- 設定保存時に自動接続
- 起動時の自動接続（設定がある場合）
- 接続時メッセージ: online（willトピックに**retain**でpublish）
- 切断時メッセージ: away（willメッセージ、**retain**）
- 接続失敗時: 映像外周に赤ボーダー表示

### 6.2 トピック構造
プレフィックス: `{prefix}` (設定で指定)

**Subscribe:**
- `{prefix}/camera` - カメラ切り替え（ペイロード: カメラインデックス番号）
- `{prefix}/video` - 録画再生（ペイロード: 録画インデックス 0-2）

**Publish:**
- `{prefix}/status` (will トピック、または設定で指定)
  - 接続時: `online` (**retain=true**)
  - 切断時: `away` (**retain=true**)

### 6.3 メッセージ仕様
- QoS: 0（固定）
- ペイロード: シンプルな数値またはテキスト

## 7. データ永続化

### 7.1 LocalStorage
- カメラ設定（全カメラ分）
- 現在選択中のカメラインデックス
- MQTT接続設定
- UI設定

### 7.2 IndexedDB
- 録画動画データ（最大3本）

### 7.3 IndexedDBの制限事項
1. **容量制限**: ブラウザによって異なるが、通常は利用可能なディスク容量の一定割合（Chrome/Firefoxでは利用可能容量の最大60-80%程度）。LocalStorageの5-10MBと比べて大幅に大きいため、60秒の動画3本には十分。
2. **永続性**: ユーザーがブラウザのデータをクリアすると削除される。
3. **同期API不可**: 非同期APIのみのため、Promise/async-awaitを使用。
4. **オリジン単位**: 同じドメイン内でのみアクセス可能。

## 8. エラーハンドリング
- カメラアクセス拒否: 映像領域中央にメッセージ表示
- カメラ利用不可: エラーメッセージを表示
- MQTT接続エラー: 赤ボーダー表示

## 9. 技術制約
- 単一HTMLファイル（CSS/JavaScript含む）
- 外部ライブラリ: MQTT接続用ライブラリのみCDN経由で読み込み可
  - 使用ライブラリ: mqtt@5.3.4 (https://unpkg.com/mqtt@5.3.4/dist/mqtt.min.js)
- 対象ブラウザ: モダンブラウザ（Chrome/Firefox/Edge最新版）
- 対象解像度: FullHD (1920x1080)

## 10. その他の仕様

### 10.1 座標系
- size(x1, y1, x2, y2): FullHD(1920x1080)を基準としたピクセル座標
- カメラ映像のサイズに応じて、相対的に計算

### 10.2 UI操作
- カラーピッカーによる色選択
- レンジスライダーによる数値調整（リアルタイム表示値更新）
- チェックボックスによるカメラ選択

### 10.3 設定の即時反映
- 設定画面でのカメラ設定変更は、設定画面を閉じたときに反映
- カメラの追加/削除は即座に反映

## 11. 開発時の質疑応答記録

### 録画機能
- Q: 録画の開始/停止は？
- A: 「R」キーで手動開始・終了。最大60秒で自動停止。

- Q: 録画インジケータは録画に含まれる？
- A: いいえ、含めない。

- Q: 録画の保存先は？
- A: IndexedDBを使用。LocalStorageは容量制限があるため不適切。

### MQTT機能
- Q: 接続設定の保存場所は？
- A: LocalStorage。設定画面はモーダルで表示。

- Q: Publish時のretainは？
- A: **必須**。online/awayメッセージは両方ともretain=trueで送信。

### UI/UX
- Q: 複数カメラの表示方法は？
- A: 同時表示はせず、1台のみ表示。矢印キーで切り替え。

- Q: 設定画面の閉じ方は？
- A: 閉じるボタン、またはESCキー。

- Q: レスポンシブデザインは必要？
- A: いいえ、FullHD(1920x1080)のPC専用。

### 実装時の調整事項

#### 設定画面のレイアウト
- 設定画面を開いたとき: カメラ映像を左上60%に縮小表示
- 通常時: 全画面でカメラ映像を表示
- カメラ映像のアスペクト比: 常に16:9を保持

#### 表示領域（クロップ）の実装方式
- 当初: clip-pathやobject-positionでクロップ
- 最終: 背景色のオーバーレイ（4つの長方形）を前面配置
  - 理由: よりシンプルで確実な実装、リサイズ対応が容易

#### ビデオサイズの設定方法
- 当初: element.styleでピクセル指定
- 最終: width: 100%, height: 100%でCSSに委譲
  - 理由: コンテナサイズの変更に自動追随

#### 設定画面の開閉タイミング
- CSSトランジション（300ms）完了後に再描画（350ms遅延）
- これによりコンテナサイズ変更が完全に終わってから処理

#### カメラ切り替え時の設定保存
- 設定画面が開いているときにカメラを切り替える場合:
  1. 現在のカメラの設定を保存
  2. カメラを切り替え
  3. 新しいカメラの設定をUIに読み込む
